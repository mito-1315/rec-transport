<!DOCTYPE html>
<html>
<head>
    <title>Chennai Roads Complete Coverage - 50km Radius</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            color: white;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            flex-grow: 1;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-container {
            background: white;
            padding: 0 20px 20px;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #666;
        }

        #map {
            height: 60vh;
            width: 100%;
            border-top: 4px solid #667eea;
        }

        .data-summary {
            background: white;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #667eea;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .data-preview {
            background: white;
            margin: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .preview-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .preview-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: #f8f9fa;
        }

        .export-actions {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>üõ£Ô∏è Chennai Roads Complete Database</h1>
    <p>All Highway & Arterial Roads within 50km radius - Ultra High Precision Coordinates</p>
</div>

<div class="controls">
    <button class="btn" id="fetchBtn" onclick="startCompleteFetch()">
        üöÄ Fetch All Roads (50km)
    </button>
    <button class="btn" onclick="clearAll()">üóëÔ∏è Clear All</button>
    <button class="btn" onclick="downloadCompleteJSON()" id="downloadBtn" disabled>
        üíæ Download Complete JSON
    </button>
    <div class="status" id="status">
        Ready to fetch comprehensive road data
    </div>
</div>

<div class="progress-container">
    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">Click "Fetch All Roads" to begin</div>
</div>

<div id="map"></div>

<div class="data-summary" id="dataSummary" style="display: none;">
    <div class="stat-card">
        <span class="stat-number" id="highwayCount">0</span>
        <div class="stat-label">Highway Segments</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="arterialCount">0</span>
        <div class="stat-label">Arterial Segments</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="totalPoints">0</span>
        <div class="stat-label">Total Coordinate Points</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="totalDistance">0</span>
        <div class="stat-label">Estimated Distance (km)</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="fileSize">0</span>
        <div class="stat-label">JSON File Size (MB)</div>
    </div>
</div>

<div class="data-preview" id="dataPreview" style="display: none;">
    <div class="preview-header">üìã Data Structure Preview</div>
    <div class="preview-content" id="previewContent"></div>
</div>

<div class="export-actions" style="display: none;" id="exportActions">
    <h3>üì§ Export Complete Dataset</h3>
    <div class="export-grid">
        <button class="export-btn" onclick="downloadCompleteJSON()">
            üìÑ Complete JSON Database
        </button>
        <button class="export-btn" onclick="downloadHighwaysOnly()">
            üõ£Ô∏è Highways Only (JSON)
        </button>
        <button class="export-btn" onclick="downloadArterialsOnly()">
            üõ§Ô∏è Arterials Only (JSON)
        </button>
        <button class="export-btn" onclick="downloadCoordinatesCSV()">
            üìä Coordinates CSV
        </button>
        <button class="export-btn" onclick="downloadGeoJSON()">
            üó∫Ô∏è GeoJSON Format
        </button>
        <button class="export-btn" onclick="copyAllCoordinates()">
            üìã Copy All Coordinates
        </button>
    </div>
</div>

<script>
    let map;
    let allRoadsData = {
        metadata: {
            region: 'Chennai Metropolitan Area',
            searchRadius: '50km',
            center: { lat: 13.0827, lng: 80.2707 },
            fetchDate: null,
            totalSegments: 0,
            totalCoordinatePoints: 0,
            estimatedDistance: 0
        },
        highways: [],
        arterials: []
    };
    let drawnRoads = [];
    
    // Chennai coordinates with 50km radius
    const chennaiCenter = { lat: 13.0827, lng: 80.2707 };
    const searchRadius = 0.45; // ~50km in degrees

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: chennaiCenter,
            zoom: 9,
            styles: [
                {
                    featureType: 'road.highway',
                    elementType: 'geometry',
                    stylers: [{ color: '#007BFF' }, { weight: 4 }]
                },
                {
                    featureType: 'road.arterial',
                    elementType: 'geometry',
                    stylers: [{ color: '#FFA500' }, { weight: 3 }]
                },
                {
                    featureType: 'road.local',
                    stylers: [{ visibility: 'simplified' }]
                },
                {
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }]
                }
            ]
        });

        // Draw 50km search boundary
        new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map,
            center: chennaiCenter,
            radius: 50000 // 50km
        });
    }

    function updateProgress(percent, text) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').textContent = text;
    }

    function updateStatus(message, showSpinner = false) {
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = showSpinner ? 
            `<div class="spinner"></div> ${message}` : message;
    }

    function clearAll() {
        drawnRoads.forEach(road => road.setMap(null));
        drawnRoads = [];
        allRoadsData.highways = [];
        allRoadsData.arterials = [];
        document.getElementById('dataSummary').style.display = 'none';
        document.getElementById('dataPreview').style.display = 'none';
        document.getElementById('exportActions').style.display = 'none';
        document.getElementById('downloadBtn').disabled = true;
        updateProgress(0, 'Cleared - Ready to fetch');
        updateStatus('Data cleared - Ready for new fetch');
    }

    async function startCompleteFetch() {
        const fetchBtn = document.getElementById('fetchBtn');
        fetchBtn.disabled = true;
        fetchBtn.innerHTML = '‚è≥ Fetching...';
        
        updateStatus('Initializing comprehensive road fetch...', true);
        clearAll();

        try {
            await fetchCompleteRoadNetwork();
            
            // Auto-download JSON after successful fetch
            setTimeout(() => {
                downloadCompleteJSON();
            }, 1000);
            
        } catch (error) {
            console.error('Fetch failed:', error);
            updateStatus('‚ùå Fetch failed - Check console for details');
        } finally {
            fetchBtn.disabled = false;
            fetchBtn.innerHTML = 'üöÄ Fetch All Roads (50km)';
        }
    }

    async function fetchCompleteRoadNetwork() {
        updateProgress(5, 'Calculating search boundaries...');
        
        // 50km search area around Chennai
        const south = chennaiCenter.lat - searchRadius;
        const west = chennaiCenter.lng - searchRadius;
        const north = chennaiCenter.lat + searchRadius;
        const east = chennaiCenter.lng + searchRadius;

        updateProgress(10, 'Building comprehensive query...');

        // Ultra-comprehensive query for maximum road coverage
        const overpassQuery = `
            [out:json][timeout:90];
            (
                way["highway"~"^(motorway|trunk|primary|secondary|tertiary|motorway_link|trunk_link|primary_link|secondary_link|tertiary_link)$"](${south},${west},${north},${east});
                rel["type"="route"]["route"~"^(road)$"](${south},${west},${north},${east});
            );
            out geom;
        `;

        updateProgress(15, 'Querying Overpass API...');
        updateStatus('Fetching road data from OpenStreetMap...', true);

        const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(overpassQuery);
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        updateProgress(30, `Processing ${data.elements.length} road elements...`);

        console.log(`Fetched ${data.elements.length} road elements from 50km radius`);

        // Process all road elements
        let processedCount = 0;
        let totalCoordinatePoints = 0;
        let estimatedDistance = 0;

        for (const [index, way] of data.elements.entries()) {
            if (way.geometry && way.tags && way.tags.highway) {
                const coordinates = way.geometry.map(p => [p.lat, p.lon]);
                const roadType = way.tags.highway;
                const roadName = way.tags.name || way.tags.ref || `Unnamed ${roadType} Road`;

                // Classify roads with expanded categories
                const isHighway = ['motorway', 'trunk', 'motorway_link', 'trunk_link'].includes(roadType);
                const isArterial = ['primary', 'secondary', 'tertiary', 'primary_link', 'secondary_link', 'tertiary_link'].includes(roadType);

                if (isHighway || isArterial) {
                    const roadData = {
                        id: way.id,
                        name: roadName,
                        type: roadType,
                        coordinates: coordinates,
                        pointCount: coordinates.length,
                        estimatedLength: calculateDistance(coordinates),
                        tags: way.tags,
                        bounds: calculateBounds(coordinates)
                    };

                    // Add to appropriate category
                    if (isHighway) {
                        allRoadsData.highways.push(roadData);
                    } else {
                        allRoadsData.arterials.push(roadData);
                    }

                    // Draw on map with high precision
                    const path = coordinates.map(c => ({ lat: c[0], lng: c[1] }));
                    const polyline = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: isHighway ? "#007BFF" : "#FFA500",
                        strokeOpacity: 0.8,
                        strokeWeight: isHighway ? 5 : 4,
                        map: map
                    });

                    drawnRoads.push(polyline);
                    totalCoordinatePoints += coordinates.length;
                    estimatedDistance += roadData.estimatedLength;
                    processedCount++;
                }
            }

            // Update progress
            const progress = 30 + (index / data.elements.length) * 60;
            updateProgress(progress, `Processed ${processedCount} roads...`);
        }

        // Update metadata
        allRoadsData.metadata.fetchDate = new Date().toISOString();
        allRoadsData.metadata.totalSegments = allRoadsData.highways.length + allRoadsData.arterials.length;
        allRoadsData.metadata.totalCoordinatePoints = totalCoordinatePoints;
        allRoadsData.metadata.estimatedDistance = Math.round(estimatedDistance);

        updateProgress(95, 'Finalizing data structure...');
        
        // Update UI
        updateDataSummary();
        showDataPreview();
        
        updateProgress(100, `‚úÖ Complete! ${allRoadsData.metadata.totalSegments} roads with ${totalCoordinatePoints} coordinates`);
        updateStatus(`‚úÖ Fetch complete! Ready for export.`);
        
        document.getElementById('downloadBtn').disabled = false;
        
        console.log('=== COMPLETE CHENNAI 50KM ROAD DATABASE ===');
        console.log('Total Highways:', allRoadsData.highways.length);
        console.log('Total Arterials:', allRoadsData.arterials.length);
        console.log('Total Coordinate Points:', totalCoordinatePoints);
        console.log('Estimated Distance:', estimatedDistance, 'km');
        console.log('Complete Data Object:', allRoadsData);
    }

    function calculateDistance(coordinates) {
        let distance = 0;
        for (let i = 1; i < coordinates.length; i++) {
            distance += getDistanceFromLatLonInKm(
                coordinates[i-1][0], coordinates[i-1][1],
                coordinates[i][0], coordinates[i][1]
            );
        }
        return distance;
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180);
    }

    function calculateBounds(coordinates) {
        const lats = coordinates.map(c => c[0]);
        const lngs = coordinates.map(c => c[1]);
        return {
            north: Math.max(...lats),
            south: Math.min(...lats),
            east: Math.max(...lngs),
            west: Math.min(...lngs)
        };
    }

    function updateDataSummary() {
        document.getElementById('highwayCount').textContent = allRoadsData.highways.length.toLocaleString();
        document.getElementById('arterialCount').textContent = allRoadsData.arterials.length.toLocaleString();
        document.getElementById('totalPoints').textContent = allRoadsData.metadata.totalCoordinatePoints.toLocaleString();
        document.getElementById('totalDistance').textContent = allRoadsData.metadata.estimatedDistance.toLocaleString();
        
        const jsonSize = (JSON.stringify(allRoadsData).length / (1024 * 1024)).toFixed(2);
        document.getElementById('fileSize').textContent = jsonSize;
        
        document.getElementById('dataSummary').style.display = 'grid';
        document.getElementById('exportActions').style.display = 'block';
    }

    function showDataPreview() {
        const preview = {
            metadata: allRoadsData.metadata,
            sampleHighway: allRoadsData.highways[0] || null,
            sampleArterial: allRoadsData.arterials[0] || null
        };
        
        document.getElementById('previewContent').textContent = JSON.stringify(preview, null, 2);
        document.getElementById('dataPreview').style.display = 'block';
    }

    function downloadCompleteJSON() {
        if (allRoadsData.highways.length === 0 && allRoadsData.arterials.length === 0) {
            alert('No data to download. Please fetch roads first.');
            return;
        }

        const jsonData = JSON.stringify(allRoadsData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `chennai-complete-roads-50km-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        updateStatus('‚úÖ Complete JSON database downloaded!');
    }

    function downloadHighwaysOnly() {
        const highwayData = {
            metadata: { ...allRoadsData.metadata, type: 'highways_only' },
            highways: allRoadsData.highways
        };
        downloadJSON(highwayData, 'chennai-highways-only-50km');
    }

    function downloadArterialsOnly() {
        const arterialData = {
            metadata: { ...allRoadsData.metadata, type: 'arterials_only' },
            arterials: allRoadsData.arterials
        };
        downloadJSON(arterialData, 'chennai-arterials-only-50km');
    }

    function downloadCoordinatesCSV() {
        let csvContent = 'Road Name,Road Type,Category,Latitude,Longitude,Point Index\n';
        
        allRoadsData.highways.forEach(road => {
            road.coordinates.forEach((coord, index) => {
                csvContent += `"${road.name}","${road.type}","Highway",${coord[0]},${coord[1]},${index}\n`;
            });
        });
        
        allRoadsData.arterials.forEach(road => {
            road.coordinates.forEach((coord, index) => {
                csvContent += `"${road.name}","${road.type}","Arterial",${coord[0]},${coord[1]},${index}\n`;
            });
        });

        downloadFile(csvContent, 'chennai-road-coordinates-50km.csv', 'text/csv');
    }

    function downloadGeoJSON() {
        const geoJSON = {
            type: "FeatureCollection",
            features: []
        };

        [...allRoadsData.highways, ...allRoadsData.arterials].forEach(road => {
            geoJSON.features.push({
                type: "Feature",
                properties: {
                    name: road.name,
                    highway: road.type,
                    category: allRoadsData.highways.includes(road) ? 'highway' : 'arterial'
                },
                geometry: {
                    type: "LineString",
                    coordinates: road.coordinates.map(c => [c[1], c[0]]) // GeoJSON uses [lng, lat]
                }
            });
        });

        downloadJSON(geoJSON, 'chennai-roads-50km.geojson');
    }

    function copyAllCoordinates() {
        const allCoords = [];
        
        allRoadsData.highways.forEach(road => {
            allCoords.push(`// HIGHWAY: ${road.name} (${road.type})`);
            allCoords.push(JSON.stringify(road.coordinates));
        });
        
        allRoadsData.arterials.forEach(road => {
            allCoords.push(`// ARTERIAL: ${road.name} (${road.type})`);
            allCoords.push(JSON.stringify(road.coordinates));
        });

        navigator.clipboard.writeText(allCoords.join('\n')).then(() => {
            updateStatus('‚úÖ All coordinates copied to clipboard!');
        });
    }

    function downloadJSON(data, filename) {
        const jsonData = JSON.stringify(data, null, 2);
        downloadFile(jsonData, `${filename}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKrYOHcwBxUYQDPGo19lDNJtn_sukLn60&callback=initMap">
</script>

</body>
</html><!DOCTYPE html>
<html>
<head>
    <title>Chennai Roads Complete Coverage - 50km Radius</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            color: white;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            flex-grow: 1;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-container {
            background: white;
            padding: 0 20px 20px;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #666;
        }

        #map {
            height: 60vh;
            width: 100%;
            border-top: 4px solid #667eea;
        }

        .data-summary {
            background: white;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #667eea;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .data-preview {
            background: white;
            margin: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .preview-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .preview-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: #f8f9fa;
        }

        .export-actions {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>üõ£Ô∏è Chennai Roads Complete Database</h1>
    <p>All Highway & Arterial Roads within 50km radius - Ultra High Precision Coordinates</p>
</div>

<div class="controls">
    <button class="btn" id="fetchBtn" onclick="startCompleteFetch()">
        üöÄ Fetch All Roads (50km)
    </button>
    <button class="btn" onclick="clearAll()">üóëÔ∏è Clear All</button>
    <button class="btn" onclick="downloadCompleteJSON()" id="downloadBtn" disabled>
        üíæ Download Complete JSON
    </button>
    <div class="status" id="status">
        Ready to fetch comprehensive road data
    </div>
</div>

<div class="progress-container">
    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">Click "Fetch All Roads" to begin</div>
</div>

<div id="map"></div>

<div class="data-summary" id="dataSummary" style="display: none;">
    <div class="stat-card">
        <span class="stat-number" id="highwayCount">0</span>
        <div class="stat-label">Highway Segments</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="arterialCount">0</span>
        <div class="stat-label">Arterial Segments</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="totalPoints">0</span>
        <div class="stat-label">Total Coordinate Points</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="totalDistance">0</span>
        <div class="stat-label">Estimated Distance (km)</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="fileSize">0</span>
        <div class="stat-label">JSON File Size (MB)</div>
    </div>
</div>

<div class="data-preview" id="dataPreview" style="display: none;">
    <div class="preview-header">üìã Data Structure Preview</div>
    <div class="preview-content" id="previewContent"></div>
</div>

<div class="export-actions" style="display: none;" id="exportActions">
    <h3>üì§ Export Complete Dataset</h3>
    <div class="export-grid">
        <button class="export-btn" onclick="downloadCompleteJSON()">
            üìÑ Complete JSON Database
        </button>
        <button class="export-btn" onclick="downloadHighwaysOnly()">
            üõ£Ô∏è Highways Only (JSON)
        </button>
        <button class="export-btn" onclick="downloadArterialsOnly()">
            üõ§Ô∏è Arterials Only (JSON)
        </button>
        <button class="export-btn" onclick="downloadCoordinatesCSV()">
            üìä Coordinates CSV
        </button>
        <button class="export-btn" onclick="downloadGeoJSON()">
            üó∫Ô∏è GeoJSON Format
        </button>
        <button class="export-btn" onclick="copyAllCoordinates()">
            üìã Copy All Coordinates
        </button>
    </div>
</div>

<script>
    let map;
    let allRoadsData = {
        metadata: {
            region: 'Chennai Metropolitan Area',
            searchRadius: '50km',
            center: { lat: 13.0827, lng: 80.2707 },
            fetchDate: null,
            totalSegments: 0,
            totalCoordinatePoints: 0,
            estimatedDistance: 0
        },
        highways: [],
        arterials: []
    };
    let drawnRoads = [];
    
    // Chennai coordinates with 50km radius
    const chennaiCenter = { lat: 13.0827, lng: 80.2707 };
    const searchRadius = 0.45; // ~50km in degrees

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: chennaiCenter,
            zoom: 9,
            styles: [
                {
                    featureType: 'road.highway',
                    elementType: 'geometry',
                    stylers: [{ color: '#007BFF' }, { weight: 4 }]
                },
                {
                    featureType: 'road.arterial',
                    elementType: 'geometry',
                    stylers: [{ color: '#FFA500' }, { weight: 3 }]
                },
                {
                    featureType: 'road.local',
                    stylers: [{ visibility: 'simplified' }]
                },
                {
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }]
                }
            ]
        });

        // Draw 50km search boundary
        new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 3,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map,
            center: chennaiCenter,
            radius: 50000 // 50km
        });
    }

    function updateProgress(percent, text) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').textContent = text;
    }

    function updateStatus(message, showSpinner = false) {
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = showSpinner ? 
            `<div class="spinner"></div> ${message}` : message;
    }

    function clearAll() {
        drawnRoads.forEach(road => road.setMap(null));
        drawnRoads = [];
        allRoadsData.highways = [];
        allRoadsData.arterials = [];
        document.getElementById('dataSummary').style.display = 'none';
        document.getElementById('dataPreview').style.display = 'none';
        document.getElementById('exportActions').style.display = 'none';
        document.getElementById('downloadBtn').disabled = true;
        updateProgress(0, 'Cleared - Ready to fetch');
        updateStatus('Data cleared - Ready for new fetch');
    }

    async function startCompleteFetch() {
        const fetchBtn = document.getElementById('fetchBtn');
        fetchBtn.disabled = true;
        fetchBtn.innerHTML = '‚è≥ Fetching...';
        
        updateStatus('Initializing comprehensive road fetch...', true);
        clearAll();

        try {
            await fetchCompleteRoadNetwork();
            
            // Auto-download JSON after successful fetch
            setTimeout(() => {
                downloadCompleteJSON();
            }, 1000);
            
        } catch (error) {
            console.error('Fetch failed:', error);
            updateStatus('‚ùå Fetch failed - Check console for details');
        } finally {
            fetchBtn.disabled = false;
            fetchBtn.innerHTML = 'üöÄ Fetch All Roads (50km)';
        }
    }

    async function fetchCompleteRoadNetwork() {
        updateProgress(5, 'Calculating search boundaries...');
        
        // 50km search area around Chennai
        const south = chennaiCenter.lat - searchRadius;
        const west = chennaiCenter.lng - searchRadius;
        const north = chennaiCenter.lat + searchRadius;
        const east = chennaiCenter.lng + searchRadius;

        updateProgress(10, 'Building comprehensive query...');

        // Ultra-comprehensive query for maximum road coverage
        const overpassQuery = `
            [out:json][timeout:90];
            (
                way["highway"~"^(motorway|trunk|primary|secondary|tertiary|motorway_link|trunk_link|primary_link|secondary_link|tertiary_link)$"](${south},${west},${north},${east});
                rel["type"="route"]["route"~"^(road)$"](${south},${west},${north},${east});
            );
            out geom;
        `;

        updateProgress(15, 'Querying Overpass API...');
        updateStatus('Fetching road data from OpenStreetMap...', true);

        const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(overpassQuery);
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        updateProgress(30, `Processing ${data.elements.length} road elements...`);

        console.log(`Fetched ${data.elements.length} road elements from 50km radius`);

        // Process all road elements
        let processedCount = 0;
        let totalCoordinatePoints = 0;
        let estimatedDistance = 0;

        for (const [index, way] of data.elements.entries()) {
            if (way.geometry && way.tags && way.tags.highway) {
                const coordinates = way.geometry.map(p => [p.lat, p.lon]);
                const roadType = way.tags.highway;
                const roadName = way.tags.name || way.tags.ref || `Unnamed ${roadType} Road`;

                // Classify roads with expanded categories
                const isHighway = ['motorway', 'trunk', 'motorway_link', 'trunk_link'].includes(roadType);
                const isArterial = ['primary', 'secondary', 'tertiary', 'primary_link', 'secondary_link', 'tertiary_link'].includes(roadType);

                if (isHighway || isArterial) {
                    const roadData = {
                        id: way.id,
                        name: roadName,
                        type: roadType,
                        coordinates: coordinates,
                        pointCount: coordinates.length,
                        estimatedLength: calculateDistance(coordinates),
                        tags: way.tags,
                        bounds: calculateBounds(coordinates)
                    };

                    // Add to appropriate category
                    if (isHighway) {
                        allRoadsData.highways.push(roadData);
                    } else {
                        allRoadsData.arterials.push(roadData);
                    }

                    // Draw on map with high precision
                    const path = coordinates.map(c => ({ lat: c[0], lng: c[1] }));
                    const polyline = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: isHighway ? "#007BFF" : "#FFA500",
                        strokeOpacity: 0.8,
                        strokeWeight: isHighway ? 5 : 4,
                        map: map
                    });

                    drawnRoads.push(polyline);
                    totalCoordinatePoints += coordinates.length;
                    estimatedDistance += roadData.estimatedLength;
                    processedCount++;
                }
            }

            // Update progress
            const progress = 30 + (index / data.elements.length) * 60;
            updateProgress(progress, `Processed ${processedCount} roads...`);
        }

        // Update metadata
        allRoadsData.metadata.fetchDate = new Date().toISOString();
        allRoadsData.metadata.totalSegments = allRoadsData.highways.length + allRoadsData.arterials.length;
        allRoadsData.metadata.totalCoordinatePoints = totalCoordinatePoints;
        allRoadsData.metadata.estimatedDistance = Math.round(estimatedDistance);

        updateProgress(95, 'Finalizing data structure...');
        
        // Update UI
        updateDataSummary();
        showDataPreview();
        
        updateProgress(100, `‚úÖ Complete! ${allRoadsData.metadata.totalSegments} roads with ${totalCoordinatePoints} coordinates`);
        updateStatus(`‚úÖ Fetch complete! Ready for export.`);
        
        document.getElementById('downloadBtn').disabled = false;
        
        console.log('=== COMPLETE CHENNAI 50KM ROAD DATABASE ===');
        console.log('Total Highways:', allRoadsData.highways.length);
        console.log('Total Arterials:', allRoadsData.arterials.length);
        console.log('Total Coordinate Points:', totalCoordinatePoints);
        console.log('Estimated Distance:', estimatedDistance, 'km');
        console.log('Complete Data Object:', allRoadsData);
    }

    function calculateDistance(coordinates) {
        let distance = 0;
        for (let i = 1; i < coordinates.length; i++) {
            distance += getDistanceFromLatLonInKm(
                coordinates[i-1][0], coordinates[i-1][1],
                coordinates[i][0], coordinates[i][1]
            );
        }
        return distance;
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180);
    }

    function calculateBounds(coordinates) {
        const lats = coordinates.map(c => c[0]);
        const lngs = coordinates.map(c => c[1]);
        return {
            north: Math.max(...lats),
            south: Math.min(...lats),
            east: Math.max(...lngs),
            west: Math.min(...lngs)
        };
    }

    function updateDataSummary() {
        document.getElementById('highwayCount').textContent = allRoadsData.highways.length.toLocaleString();
        document.getElementById('arterialCount').textContent = allRoadsData.arterials.length.toLocaleString();
        document.getElementById('totalPoints').textContent = allRoadsData.metadata.totalCoordinatePoints.toLocaleString();
        document.getElementById('totalDistance').textContent = allRoadsData.metadata.estimatedDistance.toLocaleString();
        
        const jsonSize = (JSON.stringify(allRoadsData).length / (1024 * 1024)).toFixed(2);
        document.getElementById('fileSize').textContent = jsonSize;
        
        document.getElementById('dataSummary').style.display = 'grid';
        document.getElementById('exportActions').style.display = 'block';
    }

    function showDataPreview() {
        const preview = {
            metadata: allRoadsData.metadata,
            sampleHighway: allRoadsData.highways[0] || null,
            sampleArterial: allRoadsData.arterials[0] || null
        };
        
        document.getElementById('previewContent').textContent = JSON.stringify(preview, null, 2);
        document.getElementById('dataPreview').style.display = 'block';
    }

    function downloadCompleteJSON() {
        if (allRoadsData.highways.length === 0 && allRoadsData.arterials.length === 0) {
            alert('No data to download. Please fetch roads first.');
            return;
        }

        const jsonData = JSON.stringify(allRoadsData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `chennai-complete-roads-50km-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        updateStatus('‚úÖ Complete JSON database downloaded!');
    }

    function downloadHighwaysOnly() {
        const highwayData = {
            metadata: { ...allRoadsData.metadata, type: 'highways_only' },
            highways: allRoadsData.highways
        };
        downloadJSON(highwayData, 'chennai-highways-only-50km');
    }

    function downloadArterialsOnly() {
        const arterialData = {
            metadata: { ...allRoadsData.metadata, type: 'arterials_only' },
            arterials: allRoadsData.arterials
        };
        downloadJSON(arterialData, 'chennai-arterials-only-50km');
    }

    function downloadCoordinatesCSV() {
        let csvContent = 'Road Name,Road Type,Category,Latitude,Longitude,Point Index\n';
        
        allRoadsData.highways.forEach(road => {
            road.coordinates.forEach((coord, index) => {
                csvContent += `"${road.name}","${road.type}","Highway",${coord[0]},${coord[1]},${index}\n`;
            });
        });
        
        allRoadsData.arterials.forEach(road => {
            road.coordinates.forEach((coord, index) => {
                csvContent += `"${road.name}","${road.type}","Arterial",${coord[0]},${coord[1]},${index}\n`;
            });
        });

        downloadFile(csvContent, 'chennai-road-coordinates-50km.csv', 'text/csv');
    }

    function downloadGeoJSON() {
        const geoJSON = {
            type: "FeatureCollection",
            features: []
        };

        [...allRoadsData.highways, ...allRoadsData.arterials].forEach(road => {
            geoJSON.features.push({
                type: "Feature",
                properties: {
                    name: road.name,
                    highway: road.type,
                    category: allRoadsData.highways.includes(road) ? 'highway' : 'arterial'
                },
                geometry: {
                    type: "LineString",
                    coordinates: road.coordinates.map(c => [c[1], c[0]]) // GeoJSON uses [lng, lat]
                }
            });
        });

        downloadJSON(geoJSON, 'chennai-roads-50km.geojson');
    }

    function copyAllCoordinates() {
        const allCoords = [];
        
        allRoadsData.highways.forEach(road => {
            allCoords.push(`// HIGHWAY: ${road.name} (${road.type})`);
            allCoords.push(JSON.stringify(road.coordinates));
        });
        
        allRoadsData.arterials.forEach(road => {
            allCoords.push(`// ARTERIAL: ${road.name} (${road.type})`);
            allCoords.push(JSON.stringify(road.coordinates));
        });

        navigator.clipboard.writeText(allCoords.join('\n')).then(() => {
            updateStatus('‚úÖ All coordinates copied to clipboard!');
        });
    }

    function downloadJSON(data, filename) {
        const jsonData = JSON.stringify(data, null, 2);
        downloadFile(jsonData, `${filename}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKrYOHcwBxUYQDPGo19lDNJtn_sukLn60&callback=initMap">
</script>

</body>
</html>