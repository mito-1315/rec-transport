<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bus Route Visualization - OpenRoute Services</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .stats {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        .progress-bar {
            width: 200px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Route Controls</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>Map Layers:</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showDepots" checked>
                        <label for="showDepots">Show Depots</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showStops" checked>
                        <label for="showStops">Show Pickup Stops</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showSchool" checked>
                        <label for="showSchool">Show School</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showRoutes" checked>
                        <label for="showRoutes">Show Routes</label>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Individual Routes:</label>
                    <div id="routeCheckboxes"></div>
                </div>
            </div>
            
            <div class="legend">
                <h3>Legend</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF6B6B;"></div>
                    <span>Depots</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ECDC4;"></div>
                    <span>Pickup Stops</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #45B7D1;"></div>
                    <span>School</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #96CEB4;"></div>
                    <span>Routes</span>
                </div>
            </div>
            
            <div class="stats">
                <h3>Statistics</h3>
                <div class="stat-item">
                    <span>Total Routes:</span>
                    <span id="totalRoutes">0</span>
                </div>
                <div class="stat-item">
                    <span>Total Stops:</span>
                    <span id="totalStops">0</span>
                </div>
                <div class="stat-item">
                    <span>Total Students:</span>
                    <span id="totalStudents">0</span>
                </div>
                <div class="stat-item">
                    <span>Total Distance:</span>
                    <span id="totalDistance">0 km</span>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loadingIndicator">
                <div>Loading...</div>
                <div id="progressText">Initializing...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- OpenRoute Services MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

    <script>
        let map;
        let routesData = [];
        let stopsData = {};
        let markers = {
            depots: [],
            stops: [],
            school: []
        };
        let routeLines = [];
        
        // OpenRoute Services API key (you'll need to get one from https://openrouteservice.org/)
        const OPENROUTE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjIwNzNkYjg3YzQ3MDRjNjQ4MWQ5NjIwYWE2NDNlZGUzIiwiaCI6Im11cm11cjY0In0='; // Replace with your actual API key
        
        async function loadAllData() {
            try {
                console.log('Loading route data...');
                updateProgress(20, 'Loading stop data...');
                
                // Load stop data
                const stopResponse = await fetch('./depot-stop-data.csv');
                if (!stopResponse.ok) throw new Error('Failed to load stop data');
                const stopText = await stopResponse.text();
                const stopData = await parseCSV(stopText);
                
                // Create stops lookup
                stopData.forEach(stop => {
                    stopsData[stop.stop_id] = {
                        name: stop.stop_name,
                        lat: parseFloat(stop.latitude),
                        lng: parseFloat(stop.longitude),
                        num_students: parseInt(stop.num_students),
                        is_depot: stop.is_depot === 'True',
                        is_school: stop.is_school === 'True'
                    };
                });
                
                console.log('Loaded stops:', Object.keys(stopsData).length);
                updateProgress(40, 'Loading route data...');

                // Load route data from JSON
                const routeResponse = await fetch('./optimized_routes.json');
                if (!routeResponse.ok) throw new Error('Failed to load route data');
                const routeJson = await routeResponse.json();
                routesData = routeJson.routes;
                
                console.log('Loaded routes:', routesData.length);
                updateProgress(80, 'Processing data...');
                
                // Process routes - FIXED: Use the correct JSON structure
                routesData.forEach((route, index) => {
                    // The JSON already has the correct structure, just ensure data types
                    route.route_id = route.vehicle_id || index + 1;
                    route.num_stops = route.stops ? route.stops.length : 0;
                    route.total_students = parseInt(route.load) || 0;
                    route.total_distance = parseFloat(route.distance) || 0;
                    
                    // No need to parse stops_sequence - stops array already exists
                    // route.stops is already an array of stop objects with stop_id
                });

                console.log('Data loaded successfully!');
                updateProgress(100, 'Initializing map...');
                
                // Initialize map
                setTimeout(() => {
                    initMap();
                    hideLoadingIndicator();
                }, 500);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error.message);
            }
        }

        function parseCSV(csvText) {
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            reject(new Error('CSV parsing error: ' + results.errors[0].message));
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: reject
                });
            });
        }

        function initMap() {
            console.log('Initializing map...');
            
            // Calculate center from all stops
            const allStops = Object.values(stopsData);
            const avgLat = allStops.reduce((sum, stop) => sum + stop.lat, 0) / allStops.length;
            const avgLng = allStops.reduce((sum, stop) => sum + stop.lng, 0) / allStops.length;
            
            console.log('Map center:', avgLat, avgLng);
            
            // Initialize MapLibre GL JS map with free OpenStreetMap tiles
            map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '© OpenStreetMap contributors'
                        }
                    },
                    layers: [{
                        id: 'osm-tiles',
                        type: 'raster',
                        source: 'osm',
                        minzoom: 0,
                        maxzoom: 18
                    }]
                },
                center: [avgLng, avgLat],
                zoom: 10
            });
            
            map.on('load', () => {
                createMarkers();
                createRoutes();
                setupEventListeners();
                updateStats();
                console.log('Map initialization complete!');
            });
        }

        function createMarkers() {
            console.log('Creating markers...');
            
            // Clear existing markers
            Object.values(markers).forEach(markerArray => {
                markerArray.forEach(marker => {
                    if (marker.remove) marker.remove();
                });
                markerArray.length = 0;
            });

            // Create markers for each stop
            Object.entries(stopsData).forEach(([stopId, stop]) => {
                let marker;
                let popup;
                
                if (stop.is_depot) {
                    // Depot marker
                    marker = new maplibregl.Marker({
                        color: '#FF6B6B'
                    })
                    .setLngLat([stop.lng, stop.lat])
                    .setPopup(new maplibregl.Popup().setHTML(`
                        <h3>Depot: ${stop.name}</h3>
                        <p>Location: ${stop.lat.toFixed(6)}, ${stop.lng.toFixed(6)}</p>
                    `))
                    .addTo(map);
                    
                    markers.depots.push(marker);
                    
                } else if (stop.is_school) {
                    // School marker
                    marker = new maplibregl.Marker({
                        color: '#45B7D1'
                    })
                    .setLngLat([stop.lng, stop.lat])
                    .setPopup(new maplibregl.Popup().setHTML(`
                        <h3>School: ${stop.name}</h3>
                        <p>Location: ${stop.lat.toFixed(6)}, ${stop.lng.toFixed(6)}</p>
                    `))
                    .addTo(map);
                    
                    markers.school.push(marker);
                    
                } else {
                    // Pickup stop marker
                    marker = new maplibregl.Marker({
                        color: '#4ECDC4'
                    })
                    .setLngLat([stop.lng, stop.lat])
                    .setPopup(new maplibregl.Popup().setHTML(`
                        <h3>Pickup Stop: ${stop.name}</h3>
                        <p>Students: ${stop.num_students}</p>
                        <p>Location: ${stop.lat.toFixed(6)}, ${stop.lng.toFixed(6)}</p>
                    `))
                    .addTo(map);
                    
                    markers.stops.push(marker);
                }
            });
        }

        async function createRoutes() {
            console.log('Creating routes...');
            
            // Clear existing routes
            routeLines.forEach(line => {
                if (line.remove) line.remove();
            });
            routeLines = [];
            
            console.log(`Total routes to create: ${routesData.length}`);
            
            // Create ALL routes as straight lines first (guaranteed to work)
            routesData.forEach((route, index) => {
                console.log(`Processing route ${index + 1}/${routesData.length}:`, route);
                
                if (!route.stops || route.stops.length < 2) {
                    console.warn(`Route ${route.route_id} has insufficient stops:`, route.stops);
                    return;
                }
                
                const coordinates = [];
                route.stops.forEach((stopObj, stopIndex) => {
                    const stopId = stopObj.stop_id;
                    if (stopsData[stopId]) {
                        coordinates.push([stopsData[stopId].lng, stopsData[stopId].lat]);
                        console.log(`  Stop ${stopIndex + 1}: ${stopId} at ${stopsData[stopId].lat}, ${stopsData[stopId].lng}`);
                    } else {
                        console.warn(`  Stop ${stopIndex + 1}: ${stopId} not found in stopsData`);
                    }
                });
                
                if (coordinates.length < 2) {
                    console.warn(`Route ${route.route_id} has insufficient coordinates:`, coordinates.length);
                    return;
                }
                
                createStraightLineRoute(route, index, coordinates);
                console.log(`✓ Created route ${route.route_id} with ${coordinates.length} coordinates`);
            });
            
            console.log(`Created ${routeLines.length} routes total`);
            
            // Update stats to show actual number of routes created
            updateStats();
        }
        
        function createStraightLineRoute(route, index, coordinates) {
            // Create route line with better highlighting
            const routeLine = {
                type: 'Feature',
                properties: {
                    route_id: route.route_id,
                    color: getRouteColor(index)
                },
                geometry: {
                    type: 'LineString',
                    coordinates: coordinates
                }
            };
            
            // FIXED: Use unique source and layer IDs for each route
            const sourceId = `route-source-${route.route_id}-${index}`;
            const layerId = `route-line-${route.route_id}-${index}`;
            const outlineId = `route-outline-${route.route_id}-${index}`;
            
            // Add route source
            map.addSource(sourceId, {
                type: 'geojson',
                data: routeLine
            });
            
            // Add black outline for better visibility
            map.addLayer({
                id: outlineId,
                type: 'line',
                source: sourceId,
                paint: {
                    'line-color': '#000000',
                    'line-width': 8,
                    'line-opacity': 0.4
                }
            });
            
            // Add main route line
            map.addLayer({
                id: layerId,
                type: 'line',
                source: sourceId,
                paint: {
                    'line-color': getRouteColor(index),
                    'line-width': 6,
                    'line-opacity': 0.9
                }
            });
            
            routeLines.push({
                id: layerId,
                source: sourceId,
                remove: () => {
                    if (map.getLayer(layerId)) {
                        map.removeLayer(layerId);
                    }
                    if (map.getLayer(outlineId)) {
                        map.removeLayer(outlineId);
                    }
                    if (map.getSource(sourceId)) {
                        map.removeSource(sourceId);
                    }
                }
            });
        }

        function getRouteColor(index) {
            // More vibrant and distinct colors for better visibility
            const colors = [
                '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
                '#FF8000', '#8000FF', '#FF0080', '#80FF00', '#0080FF', '#FF8000',
                '#FF4000', '#4000FF', '#FF0040', '#40FF00', '#0040FF', '#FF4000',
                '#FF2000', '#2000FF', '#FF0020', '#20FF00', '#0020FF', '#FF2000',
                '#FF1000', '#1000FF', '#FF0010', '#10FF00', '#0010FF', '#FF1000',
                '#FF0800', '#0800FF', '#FF0008', '#08FF00', '#0008FF', '#FF0800',
                '#FF0400', '#0400FF', '#FF0004', '#04FF00', '#0004FF', '#FF0400',
                '#FF0200', '#0200FF', '#FF0002', '#02FF00', '#0002FF', '#FF0200'
            ];
            return colors[index % colors.length];
        }

        function setupEventListeners() {
            // Control event listeners
            document.getElementById('showDepots').addEventListener('change', toggleDepots);
            document.getElementById('showStops').addEventListener('change', toggleStops);
            document.getElementById('showSchool').addEventListener('change', toggleSchool);
            document.getElementById('showRoutes').addEventListener('change', toggleRoutes);
            
            // Create individual route checkboxes
            createRouteCheckboxes();
        }

        function toggleDepots() {
            const show = document.getElementById('showDepots').checked;
            markers.depots.forEach(marker => {
                if (show) {
                    marker.addTo(map);
                } else {
                    marker.remove();
                }
            });
        }

        function toggleStops() {
            const show = document.getElementById('showStops').checked;
            markers.stops.forEach(marker => {
                if (show) {
                    marker.addTo(map);
                } else {
                    marker.remove();
                }
            });
        }

        function toggleSchool() {
            const show = document.getElementById('showSchool').checked;
            markers.school.forEach(marker => {
                if (show) {
                    marker.remove();
                } else {
                    marker.addTo(map);
                }
            });
        }

        function toggleRoutes() {
            const show = document.getElementById('showRoutes').checked;
            routeLines.forEach(line => {
                if (show) {
                    // Re-add the route
                    if (!map.getLayer(line.id)) {
                        map.addLayer({
                            id: line.id,
                            type: 'line',
                            source: line.source,
                            paint: {
                                'line-color': getRouteColor(parseInt(line.id.split('-')[2])),
                                'line-width': 3,
                                'line-opacity': 0.8
                            }
                        });
                    }
                } else {
                    // Remove the route
                    if (map.getLayer(line.id)) {
                        map.removeLayer(line.id);
                    }
                }
            });
        }

        function createRouteCheckboxes() {
            const container = document.getElementById('routeCheckboxes');
            container.innerHTML = '';
            
            routesData.forEach((route, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `route-${route.route_id}`;
                checkbox.checked = true;
                checkbox.addEventListener('change', (e) => toggleIndividualRoute(route.route_id, e.target.checked));
                
                const label = document.createElement('label');
                label.htmlFor = `route-${route.route_id}`;
                label.textContent = `Route ${route.route_id} (${route.num_stops} stops)`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        function toggleIndividualRoute(routeId, show) {
            // Find all layers for this route (they now have index suffixes)
            const routeLayers = routeLines.filter(r => r.id.includes(`route-line-${routeId}-`));
            
            routeLayers.forEach(routeLayer => {
                if (show) {
                    // Re-add the route
                    if (!map.getLayer(routeLayer.id)) {
                        const routeIndex = parseInt(routeLayer.id.split('-').pop());
                        map.addLayer({
                            id: routeLayer.id,
                            type: 'line',
                            source: routeLayer.source,
                            paint: {
                                'line-color': getRouteColor(routeIndex),
                                'line-width': 6,
                                'line-opacity': 0.9
                            }
                        });
                        
                        // Also add outline
                        const outlineId = routeLayer.id.replace('route-line-', 'route-outline-');
                        if (!map.getLayer(outlineId)) {
                            map.addLayer({
                                id: outlineId,
                                type: 'line',
                                source: routeLayer.source,
                                paint: {
                                    'line-color': '#000000',
                                    'line-width': 8,
                                    'line-opacity': 0.4
                                }
                            });
                        }
                    }
                } else {
                    // Remove the route
                    if (map.getLayer(routeLayer.id)) {
                        map.removeLayer(routeLayer.id);
                    }
                    
                    // Also remove outline
                    const outlineId = routeLayer.id.replace('route-line-', 'route-outline-');
                    if (map.getLayer(outlineId)) {
                        map.removeLayer(outlineId);
                    }
                }
            });
        }

        function updateStats() {
            document.getElementById('totalRoutes').textContent = routesData.length;
            document.getElementById('totalStops').textContent = Object.keys(stopsData).length;
            
            const totalStudents = routesData.reduce((sum, route) => sum + route.total_students, 0);
            document.getElementById('totalStudents').textContent = totalStudents;
            
            const totalDistance = routesData.reduce((sum, route) => sum + route.total_distance, 0);
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function hideLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Load PapaParse for CSV parsing
        function loadPapaParse() {
            return new Promise((resolve, reject) => {
                if (window.Papa) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize when page loads
        window.addEventListener('load', async () => {
            await loadPapaParse();
            loadAllData();
        });
    </script>
</body>
</html>